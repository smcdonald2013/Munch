<!DOCTYPE html>
<html>
    <head>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    </head>
<body>
<script src="static/request_helpers.js" type="text/javascript"></script>

<script>
//Makes the get request that pulls list of recipes
function load_recipes(data){
  console.log(data)

  var datalist = document.getElementById('recipes');
  data.forEach(function(item) {
    var option = document.createElement('option');
    option.value = item;
    datalist.appendChild(option);
    });
};
</script>

<script>
//Makes the get request that pulls list of recipes
function load_items(data){
  console.log(data)

  var datalist = document.getElementById('items');
  data.forEach(function(item) {
    var option = document.createElement('option');
    option.value = item;
    datalist.appendChild(option);
    });
};
</script>

<script>window.onload = make_request("/recipes", load_recipes);</script>
<script>window.onload = make_request("/items", load_items);</script>

<script type="text/javascript">
//Called when button clicked, will add recipe to list 
function addRecipe(){
  var table = document.getElementById('recipe_table');
  var n_rows = table.rows.length;

  var row = table.insertRow(-1);
  var cell = document.createElement('td');
  var text = document.createElement('input');
  text.setAttribute('type', 'text')
  var entry = document.getElementById('recipelist');
  text.value = entry.value;
  cell.appendChild(text)
  row.appendChild(cell)
};
</script>

<script type="text/javascript">
//Called when button clicked, will add item to list 
function addItem(){
  var table = document.getElementById('item_table');
  var n_rows = table.rows.length;

  var row = table.insertRow(-1);
  var cell = document.createElement('td');
  var text = document.createElement('input');
  text.setAttribute('type', 'text')
  var entry = document.getElementById('itemlist');
  text.value = entry.value;
  cell.appendChild(text)
  row.appendChild(cell)
};
</script>

<datalist id="recipes"></datalist>

<P>Please Select your Recipes</P>
<input id="recipelist" type="email" list="recipes" multiple>
<input id="clickMe" type="button" value="Add Recipe" onclick="addRecipe();" />

<p>Recipes Selected</p>
<form id='recipe_form'>
  <table id='recipe_table'>
  <tbody>
  </tbody>
  </table>
  <input id="clickMe" type="button" value="Create Shopping List" onclick="createRecipeList();" />
  <br/>
</form>

<datalist id="items"></datalist>

<P>Add Additional Items</P>
<input id="itemlist" type="email" list="items" multiple>
<input id="clickMe" type="button" value="Add Item" onclick="addItem();" />

<p>Items Selected</p>
<form id='item_form'>
  <table id='item_table'>
  <tbody>
  </tbody>
  </table>
  <input id="clickMe" type="button" value="Create Shopping List" onclick="createItemList();" />
  <br/>
</form>

<p>Shopping List</p>
<form id='grocery_form' onsubmit="return post_request()">
  <table id='grocery_table'>
  <tr>
    <th>Food Name</th>
    <th>Food Units</th>
    <th>Food Units Name</th>
    <th>Food Alt Units</th>
    <th>Food Alt Name</th>
  </tr>
  </table>
  <input type="submit" value="Submit">
  <br/>
</form>
<input id="clickMe" type="button" value="Sort Grocery List" onclick="sortTable();" />
<input id="clickMe" type="button" value="Pull List" onclick="pullList();" />


<script type="text/javascript">
//Generates grocery list from selections
function createRecipeList(){
    var myTableArray = [];

    $('#recipe_table tr').has('td').each(function() {
        $('td', $(this)).each(function(index, item) {
            arrayitem = $(item).find('input').val()//.html();
            myTableArray.push(arrayitem)
        });
    });

    //Given array, make request
    var queryString = myTableArray.join();

    ulr_str = "/recipes" + "?recipe=" + queryString 
    console.log(ulr_str)
    make_request(ulr_str,createTable);
};
</script>

<script type="text/javascript">
//Generates grocery list from selections
function createItemList(){
    var myTableArray = [];

    $('#item_table tr').has('td').each(function() {
        $('td', $(this)).each(function(index, item) {
            arrayitem = $(item).find('input').val()//.html();
            myTableArray.push(arrayitem)
        });
    });

    //Given array, make request
    var queryString = myTableArray.join();

    ulr_str = "/items" + "?item=" + queryString 
    console.log(ulr_str)
    make_request(ulr_str,createTableItem);
};
</script>

<script type="text/javascript">
//Builds the table containing the grocery list
function createTable(tableData) {
  console.log(tableData)
  var table = document.getElementById('grocery_table')

  var tableBody = document.createElement('tbody');

  tableData.forEach(function(rowData) {
    var row = document.createElement('tr');

    rowData.forEach(function(cellData) {
      var cell = document.createElement('td');
      var text = document.createElement('input')
      text.setAttribute('type', 'text')
      text.value = cellData
      cell.appendChild(text);
      row.appendChild(cell);
    });

    tableBody.appendChild(row);
  });

  table.appendChild(tableBody);
};
</script>

<script type="text/javascript">
//Builds the table containing the grocery list
function createTableItem(tableData) {

  console.log(tableData)

  var table = document.getElementById('grocery_table')

  var tableBody = document.createElement('tbody');

  tableData.forEach(function(rowData) {
    var row = document.createElement('tr');

    var i = 0
    while (i < 5) {
      var cell = document.createElement('td');
      var text = document.createElement('input');
      text.setAttribute('type', 'text')
      text.setAttribute('id',"cell" + i.toString()); //This is new
      if (i ==0){
        text.value = rowData[1]
      }
      if (i == 2) {
        text.value = rowData[6]
      }
      cell.appendChild(text)
      row.appendChild(cell)
      i++;
    }

    tableBody.appendChild(row);
  });

  table.appendChild(tableBody);
};
</script>

<script type="text/javascript">

function post_request(){
  var array = [];
  var headers = [];
  $('#grocery_table th').each(function(index, item) {
      headers[index] = $(item).html();
  });
  $('#grocery_table tr').has('td').each(function() {
      var arrayItem = {};
      $('td', $(this)).each(function(index, item) {
          arrayItem[headers[index]] = $(item).find('input').val()//.html();
      });
      array.push(arrayItem);
  });
  var data = JSON.stringify(array);

  url = "/lists"
  var xhr = createCORSRequest('POST', url);
  if (!xhr) {
    throw new Error('CORS not supported');
  }

  xhr.setRequestHeader("Content-type", "application/json");

  xhr.onerror = function() {console.log('There was an error!');};

  console.log(data)
  xhr.send(data);
  return false;
};
</script>

<script type="text/javascript">
function sortTable() {
  //Using code from link below. 
  //https://www.w3schools.com/howto/howto_js_sort_table.asp
  var table, rows, switching, i, x, y, shouldSwitch;
  table = document.getElementById('grocery_table');
  switching = true;
  /*Make a loop that will continue until
  no switching has been done:*/
  while (switching) {
    //start by saying: no switching is done:
    switching = false;
    rows = table.getElementsByTagName("TR");
    /*Loop through all table rows (except the
    first, which contains table headers):*/
    for (i = 1; i < (rows.length - 1); i++) {
      //start by saying there should be no switching:
      shouldSwitch = false;
      /*Get the two elements you want to compare,
      one from current row and one from the next:*/
      x = rows[i].getElementsByTagName("TD")[0];
      y = rows[i + 1].getElementsByTagName("TD")[0];
      //check if the two rows should switch place:
      if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
        //if so, mark as a switch and break the loop:
        shouldSwitch= true;
        break;
      }
    }
    if (shouldSwitch) {
      /*If a switch has been marked, make the switch
      and mark that a switch has been done:*/
      rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
      switching = true;
    }
  }
}
</script>

<script type="text/javascript">
function pullList() {
  make_request("/lists", createTable);
}
</script>